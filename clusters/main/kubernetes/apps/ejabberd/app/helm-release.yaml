---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: ejabberd
  namespace: ejabberd
spec:
  interval: 15m
  chart:
    spec:
      chart: ./charts/incubator/ejabberd
      version: 0.0.1
      sourceRef:
        kind: GitRepository
        name: oreste
        namespace: flux-system
      interval: 15m
  timeout: 20m
  maxHistory: 3
  driftDetection:
    mode: warn
  install:
    createNamespace: true
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  uninstall:
    keepHistory: false
  values:
    ingress:
      main:
        ingressClassName: internal
        enabled: true
        hosts:
          - host: "ejabberd.cloud.local"
            paths:
              - path: /
        tls:
          - hosts:
              - ejabberd.cloud.local         
    configmap:
      config:
        enabled: true
        data:
          ejabberd.yml: |
            loglevel: debug
            hosts:
              - "localhost"
              - "127.0.0.1"
              - "ejabberd.ejabberd.svc.cluster.local"
              - "ejabberd.cloud.local"
            acl:
              admin:
                user: admin@ejabberd.cloud.local
              local:
                user_regexp: ""
              loopback:
                ip:
                - "127.0.0.0/8"
                - "::1/128"
            access_rules:
              announce:
                allow: admin
              c2s:
                allow: all
                deny: blocked
              configure:
                allow: admin
              local:
                allow: local
              muc_create:
                allow: local
              pubsub_createnode:
                allow: local
              trusted_network:
                allow: loopback
            acme:
              auto: false
            listen:
              -
                ip: "0.0.0.0"
                port: 5280
                module: ejabberd_http
                tls: false
                request_handlers:
                  /admin: ejabberd_web_admin
              -
                ip: "127.0.0.1"
                port: 5281
                transport: "tcp"
                module: ejabberd_http
                request_handlers:
                  /api: mod_http_api
